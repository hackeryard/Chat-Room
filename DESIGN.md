# 详细设计（功能和程序）

## 注册/登录模块：
用户与中心服务器建立连接之后，从用户端打包自己的用户名/ip/port/密码，标记为LOGIN/SIGNUP类型，发送给服务器服务器判断消息类型，调用Register/Login函数，连接chatdb数据库，查询用户的身份或者请求是否合法，并返回相应消息类型(LOGSUSS/LOGFAIL/SIGSUSS/SIGFAIL)给用户，用户据此判断自己是否操作成功，如果成功进入在线模式，可以进行后续操作，失败则显示错误消息

## 在线用户查询模块：
每一个用户在注册或者登陆成功，或者离开后，中心服务器会记录下用户信息，包括用户名/ip/port，通过在线用户链表的方式管理，之后打包成消息，群发给所有在线的用户，其他用户因此可以获取到最新的在线用户列表，并通过异步的方式发送UDP消息给其他的在线用户

## 在线消息模块：
每一个在线的用户，都可以通过按下Ctrl+C的方式，进入消息发送的界面：通过选择一个在线用户，键入需要发送的消息，查询此用户的信息（ip/port）之后通过UDP发送给此用户；此用户会因为收到SIGIO信号，并判断类型为C2C_CHAT，解析出用户名和消息，显示给当前用户

## 在线文件模块：
发送方进入文件发送界面后，首先选择需要接收方，之后选择本地文件，通过UDP向接收方发送一个类型为C2C_FILE的数据包，接收方通过SIGIO捕获到此数据包，判断后向接收方界面显示发送方/文件名/文件大小，接收方可以选择接受还是拒绝，如果拒绝，则通过UDP向发送方发送一个类型为FILE_REJ的数据包，发送方接收到之后，显示拒绝信息；如果接受，会启动TCP文件服务器，并立即发送类型为FILE_READY的数据包给发送方，发送方接收到此类型的数据包之后，启动TCP文件客户端，于文件服务器进行数据的传输，传输完毕之后打印提示给发送方和接收方。

## 离线消息模块：
首先在中心服务器维持一个用户表Auser[20][12]，表示可以存储20个用户名，当用户进入离线消息界面后，发送类型为LIST_OFFLINE的数据包给中心服务器，服务器通过查询用户表user，把结果存储到Auser里面，并对比gList（当前在线用户信息），最后把所有当前离线的用户信息（只包括用户名）发送给此用户，此用户显示离线用户表，选择一个用户发送离线消息到中心服务器，服务器接收到离线消息后，存储到数据库中，并记录发送的时间信息，当有用户登录成功之后，检查数据库中是否有待接收的离线消息，如果有，则通过UDP发送给此用户，消息格式为发送方/消息时间/消息正文，此用户接收后打印出来。